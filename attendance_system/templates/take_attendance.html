{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h2>Take Attendance: {{ course.course_name }} ({{ course.course_code }})</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-8">
                <div class="text-center">
                    <video id="video" width="640" height="480" autoplay></video>
                </div>
                <div class="d-flex justify-content-center mt-3">
                    <button id="captureBtn" class="btn btn-primary">Capture for Recognition</button>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4>Attendance List</h4>
                            <input type="date" id="attendanceDate" class="form-control" style="width: auto;" value="{{ date }}">
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recognitionStatus" class="alert" style="display: none;"></div>
                        <div class="attendance-list">
                            <table class="table table-sm" id="attendanceTable">
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Attendance records will be displayed here dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <a href="#" id="viewSummaryBtn" class="btn btn-info">View Summary</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('captureBtn');
        const recognitionStatus = document.getElementById('recognitionStatus');
        const attendanceDate = document.getElementById('attendanceDate');
        const viewSummaryBtn = document.getElementById('viewSummaryBtn');
        const courseId = {{ course.id }};
        let stream;
        
        // Store recognized students to avoid duplicates
        const recognizedStudents = new Set();
        
        // Update view summary button href
        function updateSummaryLink() {
            viewSummaryBtn.href = `/attendance_summary/${courseId}?date=${attendanceDate.value}`;
        }
        updateSummaryLink();
        
        // Update link when date changes
        attendanceDate.addEventListener('change', updateSummaryLink);
        
        // Start video stream
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(s) {
                stream = s;
                video.srcObject = stream;
            })
            .catch(function(err) {
                console.error("Error accessing the camera:", err);
                recognitionStatus.textContent = "Error accessing the camera. Please make sure camera permissions are granted.";
                recognitionStatus.className = "alert alert-danger";
                recognitionStatus.style.display = "block";
            });
        
        // Capture button click
        captureBtn.addEventListener('click', function() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const imageData = canvas.toDataURL('image/jpeg');
            
            // Show recognition in progress
            recognitionStatus.textContent = "Recognizing...";
            recognitionStatus.className = "alert alert-info";
            recognitionStatus.style.display = "block";
            
            // Send for recognition
            fetch('/recognize_face', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'image_data': imageData
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Check if already marked
                    if (recognizedStudents.has(data.student_id)) {
                        recognitionStatus.textContent = `${data.student_name} has already been marked present.`;
                        recognitionStatus.className = "alert alert-warning";
                    } else {
                        // Mark attendance
                        fetch('/record_attendance', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                'course_id': courseId,
                                'student_id': data.student_id,
                                'date': attendanceDate.value
                            })
                        })
                        .then(response => response.json())
                        .then(() => {
                            // Add to table
                            const table = document.getElementById('attendanceTable');
                            const row = table.insertRow(-1);
                            
                            const cell1 = row.insertCell(0);
                            const cell2 = row.insertCell(1);
                            const cell3 = row.insertCell(2);
                            
                            cell1.textContent = data.student_id;
                            cell2.textContent = data.student_name;
                            cell3.innerHTML = '<span class="badge bg-success">Present</span>';
                            
                            // Add to recognized set
                            recognizedStudents.add(data.student_id);
                            
                            // Show success message
                            recognitionStatus.textContent = `Successfully marked ${data.student_name} as present.`;
                            recognitionStatus.className = "alert alert-success";
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            recognitionStatus.textContent = "Error recording attendance. Please try again.";
                            recognitionStatus.className = "alert alert-danger";
                        });
                    }
                } else {
                    recognitionStatus.textContent = "No matching student found. Please try again.";
                    recognitionStatus.className = "alert alert-warning";
                }
            })
            .catch(error => {
                console.error('Error:', error);
                recognitionStatus.textContent = "Error during recognition. Please try again.";
                recognitionStatus.className = "alert alert-danger";
            });
        });
        
        // Clean up when leaving the page
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => {
                    track.stop();
                });
            }
        });
    });
</script>
{% endblock %}